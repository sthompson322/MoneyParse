<!DOCTYPE html>
<html>
  {% load static %}
  <head>
    <title>{{ template_data.title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"crossorigin="anonymous"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'css/style.css' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>

  <body>
    <!-- Header -->
    <nav class="p-3 navbar navbar-dark bg-success navbar-expand-lg">
      <div class="container">
        <a class="navbar-brand" href="#">
          <img src="{% static 'image/logo.png' %}" alt="Money Parse" style="height: 100%; max-height: 60px;">

        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav ms-auto navbar-ml">
            <a class="nav-link" href="{% url 'home.index' %}">Home</a>
            <a class="nav-link" href="{% url 'home.about' %}">About</a>
            <a class="nav-link" href="{% url 'finances.transactions_display' %}">Transactions</a>
            <a class="nav-link" href="{% url 'finances.budget' %}">Budget</a>
            <a class="nav-link" href="{% url 'finances.reports' %}">Reports</a>

            <a class="nav-link" href="{% url 'finances.profile' %}">Help</a>
            <div class="vr bg-white mx-2 d-none d-lg-block"></div>
            {% if user.is_authenticated %}
            <a class="nav-link" href="{% url 'accounts.logout' %}">Logout ({{ user.username }})</a>
            {% else %}
            <a class="nav-link" href="{% url 'accounts.login' %}">Login</a>
            <a class="nav-link" href="{% url 'accounts.signup' %}">Sign Up</a>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
    <!-- Header -->

    <div>
      {% block content %}
      {% endblock content %}
    </div>

    <!-- Footer -->
    <section class="py-1 ms-footer-bottom bg-dark text-white">
      <div class="container">
        <div class="row mt-3">

          <div class="col-md-6 mb-4">
            <h5 class="text-uppercase">MONEY PARSE</h5>
            <hr class="mb-2 mt-0" style="width: 60px; background-color: #ffffff; height: 2px" />
            <p>
              Welcome to Money Parse, your ultimate
              companion for smart financial management!
              Track expenses, budget wisely, and
              take control of your finances. Start making
              smarter money moves today.
            </p>
          </div>

          <div class="col-md-5 offset-md-1 mb-4">
            <h5 class="text-uppercase">CONTACT</h5>
            <hr class="mb-2 mt-0" style="width: 60px; background-color: #ffffff; height: 2px" />
            <p><i class="fas fa-home me-2"></i> 150-2345 Tokyo-to, Japan</p>
            <p><i class="fas fa-envelope me-2"></i> info@moneyparse.com</p>
            <p><i class="fas fa-phone me-2"></i> +81 03-3333-3333</p>
          </div>
        </div>
      </div>
    </section>

    <section class="py-1 ms-footer-bottom bg-dark text-white">
      <div class="container text-center">
        <span>© Copyright - 2024</span>
      </div>
    </section>
    <!-- Footer -->
    <!-- Chatbot Popup Button -->
    <button id="chatbotToggle" class="btn btn-success rounded-circle" style="position: fixed; bottom: 20px; right: 20px; z-index: 1050;">
      <i class="fas fa-comment-alt"></i>
    </button>

    <!-- Chatbot Popup Modal -->
    <div id="chatbotModal" class="card shadow mb-2" style="position: fixed; bottom: 80px; right: 20px; width: 300px; max-height: 400px; display: none; z-index: 1050;">
      <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <span>Mona</span>
        <button type="button" class="btn-close btn-close-white" aria-label="Close" onclick="toggleChatbot()"></button>
      </div>
      <div class="card-body" style="overflow-y: auto; max-height: 250px;" id="messages">
        <div class="text-muted small">Hi! I'm your personalized financial advisor. Ask me any questions you have!</div>
      </div>
      <div class="card-footer">
        <form onsubmit="event.preventDefault(); sendMessage();" class="d-flex gap-2">
          <input type="text" id="user-input" class="form-control" placeholder="Type here..." autocomplete="off">
          <button type="submit" class="btn btn-success">➤</button>
        </form>
      </div>
    </div>

  </body>
</html>

<script>
  const chatbotModal = document.getElementById("chatbotModal");
  const toggleBtn = document.getElementById("chatbotToggle");

  function toggleChatbot() {
    chatbotModal.style.display = chatbotModal.style.display === "none" ? "block" : "none";
  }

  toggleBtn.addEventListener("click", toggleChatbot);

  function sendMessage() {
    const inputField = document.getElementById("user-input");
    const input = inputField.value.trim();
    if (!input) return;

    const messages = document.getElementById("messages");
    messages.innerHTML += `
    <div class="d-flex justify-content-end mb-2">
      <div class="chat-bubble user">
        <span class="chat-name user">You:</span> <span class="chat-text">${input}</span>
      </div>
    </div>`;

    fetch("{% url 'home.chatbot' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: "message=" + encodeURIComponent(input)
    })
    .then(response => response.json())
    .then(data => {
      messages.innerHTML += `
      <div class="d-flex justify-content-start mb-2">
        <div class="chat-bubble bot">
          <span class="chat-name bot">Mona:</span> <div class="chat-text">${formatAsBullets(data.response)}</div>
        </div>
      </div>`;
      messages.scrollTop = messages.scrollHeight;
      inputField.value = "";
    });
  }

  document.getElementById("user-input").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      sendMessage();
    }
  });

  function formatAsBullets(text) {
  const lines = text.split('\n');
  let listStarted = false;
  let html = '';

  lines.forEach(line => {
    if (line.trim().startsWith('*')) {
      if (!listStarted) {
        html += '<ul>';
        listStarted = true;
      }
      html += `<li>${line.replace(/^\*\s*/, '')}</li>`;
    } else {
      if (listStarted) {
        html += '</ul>';
        listStarted = false;
      }
      html += `<p>${line}</p>`;
    }
  });

  if (listStarted) html += '</ul>';
    return html;
  }

  function escapeHtml(unsafe) {
    return unsafe
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

</script>

<style>
#chatbotModal {
  border-radius: 1rem;
  overflow: hidden;
}

#chatbotToggle {
  width: 60px;
  height: 60px;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.chat-bubble {
  display: inline-block;
  padding: 8px 12px;
  border-radius: 12px;
  margin-top: 4px;
  max-width: 80%;
  font-size: 14px;
}

.chat-bubble ul {
  padding-left: 20px;
  margin: 0;
}

.chat-bubble li {
  list-style-type: disc;
  margin-bottom: 4px;
}

.chat-bubble.user {
  background-color: #e0e0e0;
  color: #0d6efd;
  align-self: flex-end;
}

.chat-bubble.bot {
  background-color: #d1f5d3;
  color: #14532d;
  align-self: flex-start;
}

.chat-name {
  font-weight: bold;
  margin-right: 4px;
}

.chat-text {
  font-weight: normal;
}


</style>
